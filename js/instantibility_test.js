'use strict';

var List2Dict = require('./list2dict.js');
var fs = require('fs');

var en_words;
var de_words;
var chinese_words;

var doneCount = 0;

var done = function(){
  doneCount++;

  if (3 === doneCount) {
    test();
  };
};

var read = function(test, callback){
  fs.readFile('../tests/cases/' + test, 'utf8', function(err, data){
    if (err) throw err;

    var words = data.split('\n');
    words = words.filter(function(word){ return word.length > 0;});

    callback(words);
    done();
  });
};

function log(msg) {
  console.log(msg);
}

log('Reading source word lists...');

read('en_all', function(words){ en_words = words; });
read('de_all', function(words){ de_words = words; });
read('chinese', function(words){ chinese_words = words; });

var test = function() {
  log('Testing...')

  var en_converter = new List2Dict.TSTConverter(en_words);
  var de_converter = new List2Dict.TSTConverter(de_words);
  var chinese_converter = new List2Dict.TSTConverter(chinese_words);

  // Brute-forcefully dumped this from gaia runtime.
  var enNearByKeys = JSON.parse('{"46":{"98":0.19181633764327974,"109":0.423379813234514,"110":0.423379813234514},"97":{"100":0.17535400390625,"101":0.19181633764327974,"113":0.423379813234514,"115":0.701416015625,"119":0.423379813234514,"122":0.29144229503160113},"98":{"46":0.19181633764327974,"99":0.17535400390625,"103":0.29144229503160113,"104":0.49862291921977125,"106":0.29144229503160113,"109":0.17535400390625,"110":0.701416015625,"118":0.701416015625},"99":{"98":0.17535400390625,"100":0.29144229503160113,"102":0.49862291921977125,"103":0.29144229503160113,"118":0.701416015625,"120":0.701416015625,"122":0.17535400390625,"65533":0.19181633764327974},"100":{"97":0.17535400390625,"99":0.29144229503160113,"101":0.423379813234514,"102":0.701416015625,"103":0.17535400390625,"114":0.423379813234514,"115":0.701416015625,"116":0.19181633764327974,"119":0.19181633764327974,"120":0.49862291921977125,"122":0.29144229503160113},"101":{"97":0.19181633764327974,"100":0.423379813234514,"102":0.19181633764327974,"113":0.17535400390625,"114":0.701416015625,"115":0.423379813234514,"116":0.17535400390625,"119":0.701416015625},"102":{"99":0.49862291921977125,"100":0.701416015625,"101":0.19181633764327974,"103":0.701416015625,"104":0.17535400390625,"114":0.423379813234514,"115":0.17535400390625,"116":0.423379813234514,"118":0.29144229503160113,"120":0.29144229503160113,"121":0.19181633764327974},"103":{"98":0.29144229503160113,"99":0.29144229503160113,"100":0.17535400390625,"102":0.701416015625,"104":0.701416015625,"106":0.17535400390625,"114":0.19181633764327974,"116":0.423379813234514,"117":0.19181633764327974,"118":0.49862291921977125,"121":0.423379813234514},"104":{"98":0.49862291921977125,"102":0.17535400390625,"103":0.701416015625,"105":0.19181633764327974,"106":0.701416015625,"107":0.17535400390625,"110":0.29144229503160113,"116":0.19181633764327974,"117":0.423379813234514,"118":0.29144229503160113,"121":0.423379813234514},"105":{"104":0.19181633764327974,"106":0.423379813234514,"107":0.423379813234514,"108":0.19181633764327974,"111":0.701416015625,"112":0.17535400390625,"117":0.701416015625,"121":0.17535400390625},"106":{"98":0.29144229503160113,"103":0.17535400390625,"104":0.701416015625,"105":0.423379813234514,"107":0.701416015625,"108":0.17535400390625,"109":0.29144229503160113,"110":0.49862291921977125,"111":0.19181633764327974,"117":0.423379813234514,"121":0.19181633764327974},"107":{"104":0.17535400390625,"105":0.423379813234514,"106":0.701416015625,"108":0.701416015625,"109":0.49862291921977125,"110":0.29144229503160113,"111":0.423379813234514,"112":0.19181633764327974,"117":0.19181633764327974},"108":{"105":0.19181633764327974,"106":0.17535400390625,"107":0.701416015625,"109":0.29144229503160113,"111":0.423379813234514,"112":0.423379813234514},"109":{"46":0.423379813234514,"98":0.17535400390625,"106":0.29144229503160113,"107":0.49862291921977125,"108":0.29144229503160113,"110":0.701416015625},"110":{"46":0.423379813234514,"98":0.701416015625,"104":0.29144229503160113,"106":0.49862291921977125,"107":0.29144229503160113,"109":0.701416015625,"118":0.17535400390625},"111":{"105":0.701416015625,"106":0.19181633764327974,"107":0.423379813234514,"108":0.423379813234514,"112":0.701416015625,"117":0.17535400390625},"112":{"105":0.17535400390625,"107":0.19181633764327974,"108":0.423379813234514,"111":0.701416015625},"113":{"97":0.423379813234514,"101":0.17535400390625,"115":0.19181633764327974,"119":0.701416015625},"114":{"100":0.423379813234514,"101":0.701416015625,"102":0.423379813234514,"103":0.19181633764327974,"115":0.19181633764327974,"116":0.701416015625,"119":0.17535400390625,"121":0.17535400390625},"115":{"97":0.701416015625,"100":0.701416015625,"101":0.423379813234514,"102":0.17535400390625,"113":0.19181633764327974,"114":0.19181633764327974,"119":0.423379813234514,"120":0.29144229503160113,"122":0.49862291921977125},"116":{"100":0.19181633764327974,"101":0.17535400390625,"102":0.423379813234514,"103":0.423379813234514,"104":0.19181633764327974,"114":0.701416015625,"117":0.17535400390625,"121":0.701416015625},"117":{"103":0.19181633764327974,"104":0.423379813234514,"105":0.701416015625,"106":0.423379813234514,"107":0.19181633764327974,"111":0.17535400390625,"116":0.17535400390625,"121":0.701416015625},"118":{"98":0.701416015625,"99":0.701416015625,"102":0.29144229503160113,"103":0.49862291921977125,"104":0.29144229503160113,"110":0.17535400390625,"120":0.17535400390625},"119":{"97":0.423379813234514,"100":0.19181633764327974,"101":0.701416015625,"113":0.701416015625,"114":0.17535400390625,"115":0.423379813234514},"120":{"99":0.701416015625,"100":0.49862291921977125,"102":0.29144229503160113,"115":0.29144229503160113,"118":0.17535400390625,"122":0.701416015625,"65533":0.423379813234514},"121":{"102":0.19181633764327974,"103":0.423379813234514,"104":0.423379813234514,"105":0.17535400390625,"106":0.19181633764327974,"114":0.17535400390625,"116":0.701416015625,"117":0.701416015625},"122":{"97":0.29144229503160113,"99":0.17535400390625,"100":0.29144229503160113,"115":0.49862291921977125,"120":0.701416015625,"65533":0.423379813234514},"65533":{"99":0.19181633764327974,"120":0.423379813234514,"122":0.423379813234514}}');

  var toArrayBuffer = function(u8Buffer) {
    var buffer = new Buffer(u8Buffer);
    var arrayBuffer = new ArrayBuffer(buffer.length);
    var arrayBufferU8View = new Uint8Array(arrayBuffer);
    for (var i = 0; i < buffer.length; ++i) {
        arrayBufferU8View[i] = buffer[i];
    }
    return arrayBuffer;
  };

  var singleTest = function(blob, first, done) {
    var success = function(words) {
      if (words[0][0] === first) {
        log('Passed');
      }else{
        log('Falled. Expected: ' + first + '; got: ' + words[0][0]);
      }
      done();
    };

    var error = function(msg) {
      throw msg;
    };

    delete require.cache[require.resolve('./predictions.js')];

    var Predictions = require('./predictions.js').Predictions;

    Predictions.setDictionary(toArrayBuffer(blob));
    Predictions.setNearbyKeys(enNearByKeys);

    Predictions.predict('appl', 4, 24, 1, success, error);
  };

  // alright, this is ugly, but let's keep it as is for now

  log('English...');
  singleTest(en_converter.toBlob(), 'apple', function() {
    log('German...');
    singleTest(de_converter.toBlob(), 'Apple', function() {
      log('Chinese...');
      singleTest(chinese_converter.toBlob(), 'apple一二三', function() {
        log('English again...(should be fast on this)');
        singleTest(en_converter.toBlob(), 'apple', function() {
          process.exit();
        });
      });
    });
  });
};
